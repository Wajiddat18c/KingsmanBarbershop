<div class="col-md-6">
    <h3>Hvornår vil du booke tid?</h3>
    <p id="errormsg" style="display: none;" class="alert alert-warning"></p>
    
    <form action="/booking" method="POST">
        <label class="form-text" for="daydate">Dag:</label>
        <input id="daydate" class="form-control" name="daydate" type="text">
        <br>
        <p>Tidspunkt:</p>
        <div id="times"></div>
        <br>
        <button type="submit" class="btn btn-success">
            Næste
        </button>
        <script>
            $("#daydate").datepicker({minDate: 0, maxDate: 14, dateFormat: "yy-mm-dd"});

            $("#daydate").on("change", async (e) => {
                console.log(e.target.value);
                let response = await fetch("/booking_services/" + encodeURIComponent(e.target.value));
                let reserved = await response.json();
                console.log(reserved)
                
                //calc end date
                for (const book in reserved) {
                    let end_time = new Date(new Date(reserved[book].start_time).getTime()+reserved[book].duration*60000);
                    reserved[book].start_time = new Date(reserved[book].start_time);
                    reserved[book].end_time = end_time;
                }
                //Open hours, full duration of services & closed hour
                let closed = new Date(Date.parse(e.target.value+"T16:00"))
                document.getElementById("times").innerHTML = "";
                duration = document.getElementById("duration").value;
                let open = "T10:00"
                for(let start = new Date(Date.parse(e.target.value+open)); start < closed; start = new Date(start.getTime()+15*60000) ){
                    let available = true;
                    end = new Date(start.getTime()+duration*60000);
                    for (const book in reserved) {
                        if((start >= reserved[book].start_time && start <= reserved[book].end_time)
                            ||(end >= reserved[book].start_time && end <= reserved[book].end_time)
                            ||(start <= reserved[book].start_time && reserved[book].end_time >= end))
                        {
                            available = false;
                            break;
                        }
                    }
                    if(available)
                    {
                        console.log(start.getMinutes());
                        console.log("len: "+start.getMinutes().toString().length);
                        document.getElementById("times").innerHTML += `
                        <label class="btn btn-outline-primary">
                            <input type="radio" id="timeslot" name="timeslot" value="${start.getHours()}:${start.getMinutes()}"> 
                            ${start.getHours()}:${start.getMinutes()}
                        </label>
                        `;
                    }
                        
                }
            });
        </script>
    </form>
</div>